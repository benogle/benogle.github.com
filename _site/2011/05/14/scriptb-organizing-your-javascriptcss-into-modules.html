<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>scriptb; organizing your JavaScript/CSS into modules</title>
  <meta name="description" content="Organize your js into modules with scriptb in python." />
  <meta name="keywords" content="python, javascript, modules" />

  <link rel="stylesheet" type="text/css" href="/css/normalize.css" />
  <link rel="stylesheet" type="text/css" href="/css/basics.css" />
  <link rel="stylesheet" type="text/css" href="/css/code.css" />

  <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.js"></script>
</head>
<body>

  <div class="wrapper">
  <h1>scriptb; organizing your JavaScript/CSS into modules</h1>
  <div id="post">
    <div class="date">May 14 2011</div>

    <p><a href='https://github.com/benogle/scriptb'>Get scriptb from github</a></p>

<p>Sometimes organizing frontend assets can be pretty hard. Lets say you have a bunch of core js libraries you want to include on every page, but on the admin pages of your site, you also want to include another collection of JavaScript and CSS files. Also, you want to minify/compress your code, run with uncompressed files in dev, compressed files in production, and not have to think about it.</p>

<p>Rails and <a href='http://django-pipeline.readthedocs.org/en/latest/index.html'>django</a> both the asset pipeline. We&#8217;re still on pylons at adroll and we didn&#8217;t want to retrofit the django solution.</p>

<p>So I wrote <a href='https://github.com/benogle/scriptb'>scriptb</a>. scriptb is a small wrapper around The Goog&#8217;s closure compiler and Yahoo&#8217;s YUI compressor that accepts a configuration file explaining how to organize your modules. To solve module inclusion depending on dev or production, the scriptb configuration file can be pretty tightly integrated into your web framework. I&#8217;ll show you integration in a second. First, the configuration.</p>

<h2 id='scriptb_coniguration'>Scriptb Coniguration</h2>

<p>With the configuration file, you explicitly specify which files are in which modules, and their ordering.</p>

<p>Create a python file somewhere in your project. <code>scriptb</code> works with python only as it loads a python configuration file. This config file needs to be somewhere on the python path. Format is as follows.</p>
<div class='highlight'><pre><code class='python'><span class='kn'>import</span> <span class='nn'>os</span>

<span class='n'>d</span> <span class='o'>=</span> <span class='n'>os</span><span class='o'>.</span><span class='n'>path</span><span class='o'>.</span><span class='n'>dirname</span>

<span class='c'># define absolute paths so the script can find your files.</span>
<span class='n'>PROJECT_PATH</span> <span class='o'>=</span> <span class='n'>d</span><span class='p'>(</span><span class='n'>d</span><span class='p'>(</span><span class='n'>os</span><span class='o'>.</span><span class='n'>path</span><span class='o'>.</span><span class='n'>abspath</span><span class='p'>(</span><span class='n'>__file__</span><span class='p'>)))</span>

<span class='n'>STRUCTURE</span> <span class='o'>=</span> <span class='p'>{</span>

    <span class='c'># the keys here (&#39;JS&#39;, &#39;CSS&#39;) must be defined as dictionaries</span>
    <span class='c'># elsewhere in this module</span>
    <span class='s'>&#39;JS&#39;</span><span class='p'>:</span> <span class='p'>{</span>
        <span class='s'>&#39;base&#39;</span><span class='p'>:</span> <span class='n'>os</span><span class='o'>.</span><span class='n'>path</span><span class='o'>.</span><span class='n'>join</span><span class='p'>(</span><span class='n'>PROJECT_PATH</span><span class='p'>,</span> <span class='s'>&#39;public&#39;</span><span class='p'>,</span> <span class='s'>&#39;j&#39;</span><span class='p'>),</span>
        <span class='s'>&#39;type&#39;</span><span class='p'>:</span> <span class='s'>&#39;js&#39;</span> <span class='c'># tells scriptb how to interpret the files.</span>
    <span class='p'>},</span>

    <span class='s'>&#39;CSS&#39;</span><span class='p'>:</span> <span class='p'>{</span>
        <span class='s'>&#39;base&#39;</span><span class='p'>:</span> <span class='n'>os</span><span class='o'>.</span><span class='n'>path</span><span class='o'>.</span><span class='n'>join</span><span class='p'>(</span><span class='n'>PROJECT_PATH</span><span class='p'>,</span> <span class='s'>&#39;public&#39;</span><span class='p'>,</span> <span class='s'>&#39;c&#39;</span><span class='p'>),</span>
        <span class='s'>&#39;type&#39;</span><span class='p'>:</span> <span class='s'>&#39;css&#39;</span>
    <span class='p'>}</span>
<span class='p'>}</span>

<span class='n'>JS</span> <span class='o'>=</span> <span class='p'>{</span>
    <span class='c'># define the core module to be built at build/core.js</span>
    <span class='c'># and will be composed of the the 5 files in the list following.</span>
    <span class='s'>&#39;core&#39;</span><span class='p'>:</span> <span class='p'>(</span><span class='s'>&#39;build/core.js&#39;</span><span class='p'>,</span> <span class='p'>[</span>
        <span class='s'>&#39;jquery.js&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;include/jquery.form.js&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;include/jquery.validate.js&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;include/jquery.cookie.js&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;someother/core_file.js&#39;</span>
    <span class='p'>]),</span>

    <span class='c'># define an admin module to be included on the</span>
    <span class='c'># admin part of your site</span>
    <span class='s'>&#39;admin&#39;</span><span class='p'>:</span> <span class='p'>(</span><span class='s'>&#39;build/sections/admin.js&#39;</span><span class='p'>,[</span>
        <span class='s'>&#39;admin/common.js&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;admin/search.js&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;admin/objects.js&#39;</span><span class='p'>,</span>
    <span class='p'>])</span>
<span class='p'>}</span>

<span class='n'>CSS</span> <span class='o'>=</span> <span class='p'>{</span>
    <span class='s'>&#39;core&#39;</span><span class='p'>:</span> <span class='p'>(</span><span class='s'>&#39;build/core.css&#39;</span><span class='p'>,</span> <span class='p'>[</span>
        <span class='s'>&#39;main.css&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;forms.css&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;core/notifications.css&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;widgets/debugbar.css&#39;</span>
    <span class='p'>]),</span>

    <span class='s'>&#39;admin&#39;</span><span class='p'>:</span> <span class='p'>(</span><span class='s'>&#39;build/sections/admin.css&#39;</span><span class='p'>,</span> <span class='p'>[</span>
        <span class='s'>&#39;admin/common.css&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;admin/notifications.css&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;admin/tabs.css&#39;</span>
    <span class='p'>])</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Checkout an example in my <a href='https://github.com/benogle/vanillons/blob/master/vanillons/config/frontend_modules.py'>Vanillons Project</a>. All set. Let&#8217;s run it.</p>

<h2 id='running_scriptb'>Running scriptb</h2>

<p>First, you&#8217;ll need to install java, google&#8217;s <a href='http://code.google.com/closure/compiler/'>Closure Compiler</a>, and <a href='http://yuilibrary.com/downloads/#yuicompressor'>YUI Compressor</a>. Then you need to create some environment variables for their paths:</p>
<div class='highlight'><pre><code class='bash'><span class='nb'>export </span><span class='nv'>CLOSURE_PATH</span><span class='o'>=</span>/path/to/closure.jar
<span class='nb'>export </span><span class='nv'>YUICOMPRESSOR_PATH</span><span class='o'>=</span>/path/to/yuicompressor.jar
</code></pre>
</div>
<p>Now run it. It will use the closure compiler for JavaScript, and YUI Compressor for CSS.</p>
<div class='highlight'><pre><code class='bash'><span class='c'># HALP!</span>
scriptb.py -h

<span class='c'># Basic</span>
scriptb.py -m myapp.myconfig

<span class='c'># You can also clean</span>
scriptb.py -m myapp.myconfig clean

<span class='c'># And just build the modules of your choice</span>
scriptb.py -m myapp.mymodules core
</code></pre>
</div>
<p>Make sure you have built files where you specified.</p>

<h2 id='integrating_with_your_web_framework'>Integrating with your web framework</h2>

<p>My main requirement was to be able to call some kind of <code>require(list, of, module, names)</code> function in my templates and have all the right stuff included. I&#8217;ve only integrated this into pylons, so this is pretty mako specific.</p>

<p>First I created a template called <code>require.html</code> with a couple functions:</p>
<div class='highlight'><pre><code class='mako'><span class='cp'>&lt;%!</span>
<span class='kn'>from</span> <span class='nn'>myapp.myconfig</span> <span class='kn'>import</span> <span class='n'>JS</span><span class='p'>,</span> <span class='n'>CSS</span>
<span class='cp'>%&gt;</span><span class='x' />

<span class='cp'>&lt;%</span><span class='nb'>def</span> <span class='na'>name=</span><span class='s'>&quot;include_js(production_file, files)&quot;</span><span class='cp'>&gt;</span>
    <span class='cp'>%</span> <span class='k'>if</span> <span class='n'>c</span><span class='o'>.</span><span class='n'>is_production</span><span class='p'>:</span><span class='x' />
<span class='x'>        &lt;script type=&quot;text/javascript&quot; src=&quot;</span><span class='cp'>${</span><span class='n'>h</span><span class='o'>.</span><span class='n'>static_url</span><span class='p'>(</span><span class='s'>&#39;j&#39;</span><span class='p'>,</span> <span class='n'>production_file</span><span class='p'>)</span><span class='cp'>}</span><span class='x'>&quot; &gt;&lt;/script&gt;</span>
    <span class='cp'>%</span> <span class='k'>else</span><span class='p'>:</span><span class='x' />
        <span class='cp'>%</span> <span class='k'>for</span> <span class='n'>f</span> <span class='ow'>in</span> <span class='n'>files</span><span class='p'>:</span><span class='x' />
<span class='x'>            &lt;script type=&quot;text/javascript&quot; src=&quot;</span><span class='cp'>${</span><span class='n'>h</span><span class='o'>.</span><span class='n'>static_url</span><span class='p'>(</span><span class='s'>&#39;j&#39;</span><span class='p'>,</span> <span class='n'>f</span><span class='p'>)</span><span class='cp'>}</span><span class='x'>&quot; &gt;&lt;/script&gt;</span>
        <span class='cp'>%</span><span class='k'> endfor</span><span class='x' />
    <span class='cp'>%</span><span class='k'> endif</span><span class='x' />
<span class='cp'>&lt;/%</span><span class='nb'>def</span><span class='cp'>&gt;</span><span class='x' />
<span class='cp'>&lt;%</span><span class='nb'>def</span> <span class='na'>name=</span><span class='s'>&quot;include_css(production_file, files)&quot;</span><span class='cp'>&gt;</span>
    <span class='cp'>%</span> <span class='k'>if</span> <span class='n'>c</span><span class='o'>.</span><span class='n'>is_production</span><span class='p'>:</span><span class='x' />
<span class='x'>        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;</span><span class='cp'>${</span><span class='n'>h</span><span class='o'>.</span><span class='n'>static_url</span><span class='p'>(</span><span class='s'>&#39;c&#39;</span><span class='p'>,</span> <span class='n'>production_file</span><span class='p'>)</span><span class='cp'>}</span><span class='x'>&quot; /&gt;</span>
    <span class='cp'>%</span> <span class='k'>else</span><span class='p'>:</span><span class='x' />
        <span class='cp'>%</span> <span class='k'>for</span> <span class='n'>f</span> <span class='ow'>in</span> <span class='n'>files</span><span class='p'>:</span><span class='x' />
<span class='x'>            &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;</span><span class='cp'>${</span><span class='n'>h</span><span class='o'>.</span><span class='n'>static_url</span><span class='p'>(</span><span class='s'>&#39;c&#39;</span><span class='p'>,</span> <span class='n'>f</span><span class='p'>)</span><span class='cp'>}</span><span class='x'>&quot; /&gt;</span>
        <span class='cp'>%</span><span class='k'> endfor</span><span class='x' />
    <span class='cp'>%</span><span class='k'> endif</span><span class='x' />
<span class='cp'>&lt;/%</span><span class='nb'>def</span><span class='cp'>&gt;</span><span class='x' />

<span class='cp'>&lt;%</span><span class='nb'>def</span> <span class='na'>name=</span><span class='s'>&quot;require_js(*modules)&quot;</span><span class='cp'>&gt;</span>
    <span class='cp'>%</span> <span class='k'>for</span> <span class='n'>m</span> <span class='ow'>in</span> <span class='n'>modules</span><span class='p'>:</span><span class='x' />
        <span class='cp'>%</span> <span class='k'>if</span> <span class='n'>m</span> <span class='ow'>in</span> <span class='n'>JS</span><span class='p'>:</span><span class='x' />
<span class='x'>            </span><span class='cp'>${</span><span class='n'>include_js</span><span class='p'>(</span><span class='o'>*</span><span class='n'>JS</span><span class='p'>[</span><span class='n'>m</span><span class='p'>])</span><span class='cp'>}</span>
        <span class='cp'>%</span><span class='k'> endif</span><span class='x' />
    <span class='cp'>%</span><span class='k'> endfor</span><span class='x' />
<span class='cp'>&lt;/%</span><span class='nb'>def</span><span class='cp'>&gt;</span><span class='x' />
<span class='cp'>&lt;%</span><span class='nb'>def</span> <span class='na'>name=</span><span class='s'>&quot;require_css(*modules)&quot;</span><span class='cp'>&gt;</span>
    <span class='cp'>%</span> <span class='k'>for</span> <span class='n'>m</span> <span class='ow'>in</span> <span class='n'>modules</span><span class='p'>:</span><span class='x' />
        <span class='cp'>%</span> <span class='k'>if</span> <span class='n'>m</span> <span class='ow'>in</span> <span class='n'>CSS</span><span class='p'>:</span><span class='x' />
<span class='x'>            </span><span class='cp'>${</span><span class='n'>include_css</span><span class='p'>(</span><span class='o'>*</span><span class='n'>CSS</span><span class='p'>[</span><span class='n'>m</span><span class='p'>])</span><span class='cp'>}</span>
        <span class='cp'>%</span><span class='k'> endif</span><span class='x' />
    <span class='cp'>%</span><span class='k'> endfor</span><span class='x' />
<span class='cp'>&lt;/%</span><span class='nb'>def</span><span class='cp'>&gt;</span><span class='x' />

<span class='cp'>&lt;%</span><span class='nb'>def</span> <span class='na'>name=</span><span class='s'>&quot;require(*modules)&quot;</span><span class='cp'>&gt;</span><span class='x' />
<span class='x'>    </span><span class='cp'>${</span><span class='n'>require_js</span><span class='p'>(</span><span class='o'>*</span><span class='n'>modules</span><span class='p'>)</span><span class='cp'>}</span><span class='x' />
<span class='x'>    </span><span class='cp'>${</span><span class='n'>require_css</span><span class='p'>(</span><span class='o'>*</span><span class='n'>modules</span><span class='p'>)</span><span class='cp'>}</span><span class='x' />
<span class='cp'>&lt;/%</span><span class='nb'>def</span><span class='cp'>&gt;</span><span class='x' />
</code></pre>
</div>
<p>Note that the previous code makes reference to <code>c.is_production</code>. In my base controller, I read a config param called <code>is_production</code> from the ini passed into paster and put it in <code>c.is_production</code>.</p>

<p>And now, in my templates I can include that template and just call require().</p>
<div class='highlight'><pre><code class='mako'><span class='cp'>&lt;%</span><span class='nb'>namespace</span> <span class='na'>name=</span><span class='s'>&quot;r&quot;</span> <span class='na'>file=</span><span class='s'>&quot;/require.html&quot;</span><span class='cp'>/&gt;</span><span class='x' />

<span class='x'>... somewhere in the header</span>
<span class='cp'>${</span><span class='n'>r</span><span class='o'>.</span><span class='n'>require</span><span class='p'>(</span><span class='s'>&#39;core&#39;</span><span class='p'>)</span><span class='cp'>}</span><span class='x' />
<span class='x'>...</span>
</code></pre>
</div>
<p>Hope it is of some use to the rest of y&#8217;all.</p>

    <p><a href="/">&larr; Back to BenOgle.com</a></p>
  </div>

  
    <div id="comments">
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'benogle-test'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
    </div>
  

</div>


</body>
</html>
